{% extends "base.html.twig" %}

{% import '_macros/icons.html.twig' as icons %}

{% block title %}Przepis: {{ recipe.title|upper }}{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8 max-w-5xl">

    {# --- HEADER --- #}
    <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 border-b border-gray-100 pb-6">
        <h1 class="font-extrabold text-3xl md:text-4xl text-gray-900 leading-tight">
            {{ recipe.title }}
        </h1>

        <div class="flex items-center gap-4">
            {# Likes Counter #}
            <div class="flex items-center gap-1 text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-sm font-medium"
                title="Liczba polubie≈Ñ">
                <span class="text-red-500">{{ icons.favorite(4) }}</span>
                <span id="favorite-count-{{ recipe.id }}">{{ recipe.favoritedBy|length }}</span>
            </div>

            {# Favorite Action Button #}
            {% if is_granted('IS_EMAIL_VERIFIED') %}
            {% include "favorite/_btn.html.twig" with { "recipe": recipe } %}
            {% endif %}
        </div>
    </div>

    {# --- MAIN IMAGE & INFO --- #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-12">
        <div>
            {% set imageUrl = recipe.imageFilename
                    ? asset('/uploads/recipes/' ~ recipe.imageFilename)
                    : asset('/uploads/recipes/default.png')
                %}
            <img class="w-full h-80 lg:h-96 object-cover rounded-2xl shadow-lg" src="{{ imageUrl }}"
                alt="{{ recipe.title }} - zdjƒôcie potrawy">

            <div class="flex flex-wrap gap-4 mt-6 text-sm font-medium text-gray-600 justify-center lg:justify-start">
                <a class="flex items-center gap-2 hover:text-blue-600 transition-colors"
                    href="{{ path('app_profile_show', {'id': recipe.author.id}) }}">
                    {{ icons.user(4) }} {{ recipe.author.username|default(recipe.author.email) }}
                </a>

                {% if recipe.difficulty %}
                    <span class="flex items-center gap-1 px-3 py-1 bg-yellow-50 text-yellow-700 rounded-lg">
                        üìä {{ recipe.difficulty.getLabel() }}
                    </span>
                    {% endif %}

                    <span class="flex items-center gap-1 px-3 py-1 bg-blue-50 text-blue-700 rounded-lg">
                        ‚è±Ô∏è {{ recipe.preparationTime }} godz
                    </span>
                    {% if recipe.kcal %}
                        <span class="flex items-center gap-1 px-3 py-1 bg-green-50 text-green-700 rounded-lg"
                            title="Kalorie na ca≈Çy przepis">
                            üî• {{ recipe.kcal }} kcal
                        </span>

                    {% if recipe.servings and recipe.servings > 0 %}
                        <span class="flex items-center gap-1 px-3 py-1 bg-green-50 text-green-700 rounded-lg"
                            title="Kalorie na jednƒÖ porcjƒô">
                            üçΩÔ∏è ~{{ (recipe.kcal / recipe.servings)|round }} kcal/porcja
                        </span>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        {# --- INGREDIENTS --- #}
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                <h2 class="font-bold text-2xl text-gray-800">Sk≈Çadniki</h2>

                {# Servings Control #}
                {% if recipe.servings %}
                <div class="flex items-center bg-gray-50 rounded-lg p-1 border border-gray-200">
                    <button id="btn-decrease"
                        class="w-8 h-8 flex items-center justify-center hover:bg-white hover:shadow-sm rounded transition font-bold text-gray-600">-</button>
                    <span id="servings-display"
                        class="px-3 font-semibold text-gray-800 text-sm min-w-20 text-center"
                        data-base-servings="{{ recipe.servings }}">
                        {{ recipe.servings }} porcji
                    </span>
                    <button id="btn-increase"
                        class="w-8 h-8 flex items-center justify-center hover:bg-white hover:shadow-sm rounded transition font-bold text-gray-600">+</button>
                </div>
                {% endif %}
            </div>

            {# Add All to List #}
            {% if is_granted('IS_EMAIL_VERIFIED') %}
            <form action="{{ path('app_shopping_add', {'id': recipe.id}) }}" method="POST" class="mb-6">
                <input type="hidden" name="_token" value="{{ csrf_token('shoppingList' ~ recipe.id) }}">
                <input type="hidden" name="targetServings" value="{{ recipe.servings|default(1) }}"
                    class="js-servings-input">
                <button type="submit"
                    id="recipe-ingredients-{{ recipe.id }}"
                    class="w-full flex items-center justify-center gap-2 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 py-2 rounded-lg font-semibold transition text-sm cursor-pointer relative">
                    {{ icons.add(4) }} Dodaj wszystko do listy
                </button>
            </form>
            {% endif %}

            {# Ingredient List #}
            <ul class="space-y-3">
                {% for ingredient in recipe.recipeIngredients %}
                <li class="flex justify-between items-center group p-2 hover:bg-gray-50 rounded-lg transition-colors relative"
                    id="add-ingriedient-{{ ingredient.id }}">
                    <span class="text-gray-700">
                        {{ ingredient.name|capitalize }}
                        <span class="text-gray-500 text-sm ml-1">
                            (<strong class="ingredient-amount text-gray-900"
                                data-original-amount="{{ ingredient.quantity }}"
                                data-unit="{{ ingredient.unit ? ingredient.unit.value : '' }}">
                                {{ ingredient.quantity }}
                            </strong>
                            <span class="js-unit">{{ ingredient.unit ? ingredient.unit.value : '' }}</span>)
                        </span>
                    </span>

                    {# Add Single Item #}
                    {% if is_granted('IS_EMAIL_VERIFIED') %}
                    <form action="{{ path('app_shopping_add_item', {'id': ingredient.id}) }}" method="POST">
                        <input type="hidden" name="_token" value="{{ csrf_token('add_item' ~ ingredient.id) }}">
                        <input type="hidden" name="targetServings" value="{{ recipe.servings|default(1) }}"
                            class="js-servings-input">
                        <button type="submit"
                            class="text-gray-300 cursor-pointer hover:text-blue-600 p-1 group-hover:opacity-100
                            transition-all"
                            title="Dodaj ten sk≈Çadnik">
                            {{ icons.add() }}
                        </button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    {# --- INSTRUCTIONS --- #}
    <div class="mb-12">
        <h2 class="font-bold text-2xl text-gray-800 mb-4 border-b border-gray-100 pb-2">Przygotowanie</h2>

        <div
            class="prose max-w-none text-gray-700 leading-relaxed whitespace-pre-line bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            {{ recipe.instructions }}
        </div>

        <div class="mt-6">
            {% include "category/_tags.html.twig" with {"categories": recipe.categories} %}

            {% if recipe.dietaryTags %}
            <div class="mt-4">
                <h3 class="font-bold text-sm text-gray-500 uppercase tracking-wide mb-2">Tagi dietetyczne</h3>
                <div class="flex flex-wrap gap-2">
                    {% for tag in recipe.dietaryTags %}
                    <span
                        class="px-3 py-1 bg-green-50 text-green-700 rounded-full text-sm font-medium border border-green-100">
                        {{ tag.getLabel()|capitalize }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {# --- COMMENTS SECTION --- #}
    <div class="max-w-3xl mx-auto">
        <div class="mb-8">
            {% if app.user %}
                {% if is_granted('IS_EMAIL_VERIFIED') %}
                {% include "comment/_form.html.twig" with { "commentForm": commentForm } %}

                {% else %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 text-center shadow-sm">
                        <p class="text-yellow-800 font-medium mb-2">Chcesz dodaƒá komentarz?</p>
                        <p class="text-sm text-yellow-700 mb-4">Musisz potwierdziƒá sw√≥j adres email, aby uczestniczyƒá w
                            dyskusji.</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 text-center shadow-sm">
                    <p class="text-gray-800 font-medium mb-2">Chcesz dodaƒá komentarz?</p>
                    <p class="text-sm text-gray-600 mb-4">
                        Musisz siƒô zalogowaƒá, aby m√≥c dodawaƒá komentarze.
                    </p>
                    <a href="{{ path('app_login') }}"
                        class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-sm text-sm">
                        Zaloguj siƒô
                    </a>
                </div>
            {% endif %}
        </div>

        {% include "comment/_list.html.twig" with {"recipe": recipe} %}
    </div>

</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="{{ asset('js/recipe-scale.js') }}" defer></script>
{% endblock %}
