{% import "_macros/icons.html.twig" as icons %}

{{ form_start(form, {'attr': {'class': 'space-y-8'}}) }}

{# --- SECTION 1: BASIC INFORMATION --- #}
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
         Informacje podstawowe
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2">
            {{ form_row(form.title, {
                    'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-1'},
                    'attr': {'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none', 'placeholder': 'Np. Pizza Margherita'}
                }) }}
        </div>

        <div>
            {{ form_row(form.categories, {
                    'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-1'},
                    'attr': {'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none min-h-[120px]'}
                }) }}
        </div>

        <div class="space-y-4">
            {{ form_row(form.difficulty, {
                    'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-1'},
                    'attr': {'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none'}
                }) }}

            <div class="grid grid-cols-2 gap-4">
                {{ form_row(form.preparationTime, {
                        'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-1'},
                        'attr': {'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none', 'placeholder': 'godz'}
                    }) }}

                {{ form_row(form.servings, {
                        'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-1'},
                        'attr': {'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none', 'placeholder': 'os贸b'}
                    }) }}
            </div>
        </div>
    </div>
</div>

{# --- SECTIONS 2: DETAILS --- #}
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
         Szczeg贸y przepisu
    </h2>

    <div class="space-y-6">
        {{ form_row(form.instructions, {
                'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-1'},
                'attr': {'class': 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none min-h-[150px]', 'placeholder': 'Opisz krok po kroku jak przygotowa potraw...'}
            }) }}

        <div>
            {{ form_label(form.dietaryTags, 'Tagi dietetyczne', {'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-2'}})
            }}
            <div class="flex flex-wrap gap-4 p-4 bg-white border border-gray-300 rounded-lg">
                {% for child in form.dietaryTags %}
                <label class="flex items-center gap-2 cursor-pointer">
                    {{ form_widget(child, {'attr': {'class': 'rounded text-blue-600 focus:ring-blue-500 border-gray-300'}})
                    }}
                    <span class="text-sm text-gray-700">{{ form_label(child) }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
            <div>
                {{ form_row(form.imageFile, {
                        'label_attr': {'class': 'block text-sm font-semibold text-gray-700 mb-1'},
                        'attr': {'class': 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50
                        file:text-blue-700 hover:file:bg-blue-100 cursor-pointer'}
                    }) }}
            </div>

            {% if recipe.imageFilename %}
            <div class="flex flex-col items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
                <span class="text-xs font-semibold text-gray-500 mb-2 uppercase">Obecne zdjcie</span>
                <img src="{{ asset('/uploads/recipes/' ~ recipe.imageFilename) }}" alt="Podgld"
                    class="w-full h-40 object-cover rounded-lg">
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# --- SECTION 3: INGREDIENTS (Dynamic) --- #}
<fieldset class="bg-gray-50 p-6 rounded-xl border border-gray-200">
    <div class="flex justify-between items-center mb-4">
        <legend class="text-lg font-bold text-gray-800 flex items-center gap-2">
             Skadniki
        </legend>
        <button id="add-ingredient" type="button"
            class="flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition
            font-medium text-sm cursor-pointer">
            {{ icons.add(4) }} Dodaj skadnik
        </button>
    </div>

    {# Prototype #}
    {% set prototype_html %}
    <div class="grid grid-cols-12 gap-2 items-start animate-fade-in-down">
        <div class="col-span-6 md:col-span-7">
            {{ form_widget(form.recipeIngredients.vars.prototype.name, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm', 'placeholder': 'Nazwa'}})
            }}
        </div>
        <div class="col-span-3 md:col-span-2">
            {{ form_widget(form.recipeIngredients.vars.prototype.quantity, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm', 'placeholder': 'Ilo'}})
            }}
        </div>
        <div class="col-span-3 md:col-span-2">
            {{ form_widget(form.recipeIngredients.vars.prototype.unit, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm', 'placeholder': 'Jedn.'}})
            }}
        </div>
        <div class="col-span-3 md:col-span-2">
            {{ form_widget(form.recipeIngredients.vars.prototype.nutritionFactor, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm',
            'title': 'Ile z tego skadnika faktycznie zjadamy?'
            }})
            }}
        </div>
    </div>
    {% endset %}

    <ul id="ingredients-list" class="space-y-3"
        data-index="{{ form.recipeIngredients|length > 0 ? form.recipeIngredients|last.vars.name + 1 : 0 }}"
        data-prototype="{{ prototype_html|e('html_attr') }}" data-delete-icon="{{ icons.delete(4)|e('html_attr') }}">

        {% for ingredientForm in form.recipeIngredients %}
        <li class="relative group bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start">

                <div class="md:col-span-5">
                    <label class="block text-xs font-semibold text-gray-500 mb-1 md:hidden">Nazwa</label>
                    {{ form_widget(ingredientForm.name, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none', 'placeholder': 'Nazwa'}})
                    }}
                    {{ form_errors(ingredientForm.name) }}
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-gray-500 mb-1 md:hidden">Ilo</label>
                    {{ form_widget(ingredientForm.quantity, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none', 'placeholder': 'Ilo'}})
                    }}
                    {{ form_errors(ingredientForm.quantity) }}
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-gray-500 mb-1 md:hidden">Jednostka</label>
                    {{ form_widget(ingredientForm.unit, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none'}})
                    }}
                    {{ form_errors(ingredientForm.unit) }}
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-semibold text-gray-500 mb-1 md:hidden">Zu偶ycie kalorii</label>
                    {{ form_widget(ingredientForm.nutritionFactor, {
                        'attr': {
                            'class': 'w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white',
                            'title': 'Wybierz ile % kalorii wchania si do potrawy'
                        }
                    }) }}
                    {{ form_errors(ingredientForm.nutritionFactor) }}
                </div>
            </div>
        </li>
        {% endfor %}
    </ul>
    <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
        癸 <strong>Wskaz贸wka:</strong> Dla olej贸w do sma偶enia lub marynat wybierz odpowiedni opcj w polu "Zu偶ycie",
        aby poprawnie obliczy kalorie.
    </p>
</fieldset>

{# --- ACTIONS --- #}
<div class="flex items-center justify-between pt-6 border-t border-gray-200">
    <a href="{{ path('app_profile_show', {'id': app.user.id}) }}"
        class="text-gray-500 hover:text-gray-700 font-medium px-4 py-2 hover:bg-gray-100 rounded-lg transition">
        Anuluj
    </a>

    <button type="submit"
        class="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 cursor-pointer">
        {% if recipe.id %}
            {{ icons.edit() }} Zapisz zmiany
        {% else %}
            {{ icons.add() }} Utw贸rz przepis
        {% endif %}
    </button>
</div>

{{ form_widget(form._token) }}
{% do form.recipeIngredients.setRendered %}

{{ form_end(form, {'render_rest': false}) }}
